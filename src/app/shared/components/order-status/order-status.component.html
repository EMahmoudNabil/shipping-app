<div class="container mt-4">
  <app-page-header
    [path]="[{ name: 'الطلبات', link: '/orders' }]"
  ></app-page-header>

  <div class="row mb-4">
    <div class="col">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <button class="btn btn-primary me-2" routerLink="/orders/create">
            <i class="fas fa-plus me-1"></i> جديد
          </button>
          <button class="btn btn-secondary me-2" (click)="exportToPDF()">
            PDF
          </button>
          <button class="btn btn-secondary" (click)="exportToExcel()">
            Excel
          </button>
        </div>
        <div>
          <input
            type="text"
            class="form-control"
            placeholder="Search..."
            [(ngModel)]="searchTerm"
            (input)="onSearch()"
          />
        </div>
      </div>

      <div class="status-filter mb-4">
        <div class="d-flex flex-wrap">
          <button
            class="btn me-2 mb-2"
            *ngFor="let option of statusOptions"
            [class.btn-primary]="currentStatus === option.value"
            [class.btn-outline-secondary]="currentStatus !== option.value"
            (click)="filterByStatus(option.value)"
          >
            {{ option.label }}
          </button>
          <button
            class="btn me-2 mb-2"
            [class.btn-primary]="currentStatus === null"
            [class.btn-outline-secondary]="currentStatus !== null"
            (click)="filterByStatus(null)"
          >
            الكل
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-light">
                <tr>
                  <th>
                    <input type="checkbox" (change)="selectAllOrders($event)" />
                  </th>
                  <th>الرقم التسلسلي</th>
                  <th>التاريخ</th>
                  <th>بيانات العميل</th>
                  <th>المحافظة</th>
                  <th>المدينة</th>
                  <th>تكلفة الطلب</th>
                  <th>تعديل الطلب</th>
                  <th>تغيير الحالة</th>
                  <th>حذف</th>
                  <th>طباعة</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let order of orders">
                  <td>
                    <input type="checkbox" [(ngModel)]="order.selected" />
                  </td>
                  <td>{{ order.id }}</td>
                  <td>{{ order.createdAt | date : "dd MMM yyyy hh:mm a" }}</td>
                  <td>
                    {{ extractCustomerInfo(order, "name") }}<br />
                    {{ extractCustomerInfo(order, "phone") }}
                  </td>
                  <td>{{ order.region }}</td>
                  <td>{{ order.city }}</td>
                  <td>{{ order.orderCost | number : "1.2-2" }} ج.م</td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      [routerLink]="['/orders/edit', order.id]"
                    >
                      <i class="fas fa-edit"></i>
                    </button>
                  </td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline-info"
                      (click)="openStatusModal(order)"
                    >
                      <span class="status-text">الحالة</span>
                    </button>
                  </td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline-danger"
                      (click)="deleteOrder(order.id)"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                  <td>
                    <button
                      class="btn btn-sm btn-outline-secondary"
                      (click)="printOrder(order.id)"
                    >
                      <i class="fas fa-print"></i>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="orders.length === 0">
                  <td colspan="11" class="text-center py-4">
                    <div class="text-muted">لا توجد طلبات</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination Controls -->
          <div
            class="d-flex justify-content-between align-items-center mt-3 p-3"
          >
            <div class="d-flex align-items-center">
              <select
                class="form-select form-select-sm me-2"
                [(ngModel)]="pageSize"
                (change)="onPageSizeChange($event)"
              >
                <option [value]="5">5 عناصر</option>
                <option [value]="10">10 عناصر</option>
                <option [value]="25">25 عناصر</option>
                <option [value]="50">50 عناصر</option>
              </select>
              <span class="text-muted">إجمالي النتائج: {{ totalItems }}</span>
            </div>

            <nav aria-label="Page navigation" *ngIf="totalPages > 1">
              <ul class="pagination mb-0">
                <!-- Previous Page -->
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button
                    class="page-link"
                    (click)="prevPage()"
                    [disabled]="currentPage === 1"
                  >
                    <i class="fas fa-chevron-right"></i> السابق
                  </button>
                </li>

                <!-- Page Numbers -->
                <li
                  class="page-item"
                  *ngFor="let page of getPages()"
                  [class.active]="page === currentPage"
                >
                  <button class="page-link" (click)="onPageChange(page)">
                    {{ page }}
                  </button>
                </li>

                <!-- Next Page -->
                <li
                  class="page-item"
                  [class.disabled]="currentPage === totalPages"
                >
                  <button
                    class="page-link"
                    (click)="nextPage()"
                    [disabled]="currentPage === totalPages"
                  >
                    التالي <i class="fas fa-chevron-left"></i>
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Status Change Modal -->
<div class="modal" [class.show]="selectedOrder" [class.d-block]="selectedOrder">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          تغيير حالة الطلب رقم {{ selectedOrder?.id }}
        </h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeStatusModal()"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">اختر الحالة الجديدة</label>
          <select class="form-select" [(ngModel)]="newStatus">
            <option [ngValue]="null">اختر الحالة</option>
            <option
              *ngFor="let status of statusOptions"
              [ngValue]="status.value"
            >
              {{ status.label }}
            </option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeStatusModal()"
        >
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="updateOrderStatus()"
          [disabled]="!newStatus || newStatus === selectedOrder?.status"
        >
          <i class="fas fa-save"></i> حفظ التغييرات
        </button>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show"></div>
</div>
